<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Qu·∫£n l√Ω ƒë·ªÅ thi</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <style>
    .modal-lg-custom {
      max-width: 1200px;
    }

    .modal-body-scrollable {
      max-height: 400px;
      overflow-y: auto;
    }

    td {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 300px;
    }
  </style>
</head>
<body>

<div class="container mt-4">
  <h4>DANH S√ÅCH ƒê·ªÄ THI</h4>
  <div class="d-flex justify-content-between mb-2">
    <div>
      <label>Hi·ªÉn th·ªã
        <select class="custom-select custom-select-sm w-auto">
          <option>10</option>
          <option>25</option>
          <option>50</option>
        </select> d√≤ng
      </label>
    </div>
    <button class="btn btn-primary" data-toggle="modal" data-target="#addExamModal">+ T·∫°o m·ªõi</button>
  </div>

  <table class="table table-bordered table-hover table-sm text-center">
    <thead class="thead-light">
      <tr>
        <th>STT</th>
        <th>T√™n ƒë·ªÅ</th>
        <th>M√£ ƒë·ªÅ</th>
        <th>Th·ªùi gian (ph√∫t)</th>
        <th>Lo·∫°i c√¢u h·ªèi</th>
        <th>L·ªõp h·ªçc</th>
        <th>M√¥n h·ªçc</th>
        <th>B·∫Øt ƒë·∫ßu thi</th>
        <th>K·∫øt th√∫c thi</th>
        <th>Th√≠ sinh d·ª± thi</th>
        <th>K·∫øt qu·∫£</th>
        <th>Tr·∫°ng th√°i</th>
        <th>S·ª≠a</th>
        <th>Xo√°</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>

  <div class="d-flex justify-content-between align-items-center">
    <nav>
      <ul class="pagination pagination-sm mb-0">
        <li class="page-item active"><a class="page-link" href="#">1</a></li>
      </ul>
    </nav>
  </div>
</div>

<!-- Modal th√™m ƒë·ªÅ thi -->
<div class="modal fade" id="addExamModal" tabindex="-1" role="dialog" aria-labelledby="addExamModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-lg-custom" role="document">
    <div class="modal-content">
      <form id="examForm">
        <div class="modal-header">
          <h5 class="modal-title" id="addExamModalLabel">Th√™m ƒë·ªÅ thi</h5>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>

        <div class="modal-body">
          <div class="form-row">
            <div class="form-group col-md-6">
              <label>T√™n ƒë·ªÅ thi</label>
              <input type="text" class="form-control" name="tenDe" required />
            </div>
            <div class="form-group col-md-6">
              <label>M√£ ƒë·ªÅ thi</label>
              <input type="text" class="form-control" name="maDe" required />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-4">
              <label>L·ªõp h·ªçc</label>
              <select class="form-control" name="lopHoc">
                <option>L·ªõp 10</option>
                <option>L·ªõp 11</option>
                <option>L·ªõp 12</option>
              </select>
            </div>
            <div class="form-group col-md-4">
              <label>M√¥n h·ªçc</label>
              <select class="form-control" name="monHoc">
                <option>To√°n h·ªçc</option>
                <option>V·∫≠t l√Ω</option>
                <option>H√≥a h·ªçc</option>
              </select>
            </div>
            <div class="form-group col-md-4">
              <label>Th·ªùi gian l√†m b√†i (ph√∫t)</label>
              <input type="number" class="form-control" name="thoiGian" value="45" />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-6">
              <label>B·∫Øt ƒë·∫ßu thi</label>
              <input type="datetime-local" class="form-control" name="batDau" />
            </div>
            <div class="form-group col-md-6">
              <label>K·∫øt th√∫c thi</label>
              <input type="datetime-local" class="form-control" name="ketThuc" />
            </div>
          </div>

          <div class="form-group">
            <label for="loai">Lo·∫°i ƒë·ªÅ thi</label>
            <select class="form-control" id="loai" name="loaiDe">
              <option value="tu_mas">C√¢u h·ªèi t·ª´ danh s√°ch m√£ c√¢u h·ªèi</option>
              <option value="upload_pdf">T·∫£i l√™n file PDF</option>
            </select>
          </div>

          <!-- N√∫t m·ªü modal ch·ªçn c√¢u h·ªèi -->
          <div class="form-group">
            <button type="button" id="btnOpenSelectQuestions" class="btn btn-sm btn-outline-primary mt-2">
              Click ch·ªçn m√£
            </button>
          </div>

          <!-- Hi·ªÉn th·ªã c√¢u h·ªèi ƒë√£ ch·ªçn -->
          <div class="form-group">
            <label>C√¢u h·ªèi ƒë√£ ch·ªçn:</label>
            <ul id="selectedQuestionsList" class="list-group list-group-flush" style="max-height: 150px; overflow-y: auto;">
              <li class="list-group-item text-muted">Ch∆∞a ch·ªçn c√¢u h·ªèi n√†o.</li>
            </ul>
          </div>

          <div class="form-group">
            <label for="pdfFile">Ho·∫∑c t·∫£i l√™n file ƒë·ªÅ thi (PDF)</label>
            <input type="file" class="form-control-file" name="pdfFile" id="pdfFile" accept="application/pdf" />
            <small class="form-text text-muted">Ch·ªâ ch·∫•p nh·∫≠n ƒë·ªãnh d·∫°ng .pdf</small>
          </div>

          <div class="form-group">
            <label>Tr·∫°ng th√°i</label>
            <select class="form-control" name="trangThai">
              <option>Ho·∫°t ƒë·ªông</option>
              <option>Kh√¥ng ho·∫°t ƒë·ªông</option>
            </select>
          </div>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">L∆∞u ƒë·ªÅ thi</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">ƒê√≥ng</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal ch·ªçn c√¢u h·ªèi -->
<div class="modal fade" id="selectQuestionsModal" tabindex="-1" role="dialog" aria-labelledby="selectQuestionsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-lg-custom" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="selectQuestionsModalLabel">Ch·ªçn c√¢u h·ªèi</h5>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body modal-body-scrollable">
        <table class="table table-sm table-bordered table-hover">
          <thead>
            <tr>
              <th>Ch·ªçn</th>
              <th>M√£ c√¢u h·ªèi</th>
              <th>N·ªôi dung c√¢u h·ªèi</th>
            </tr>
          </thead>
          <tbody id="questionsTableBody">
            <!-- D·ªØ li·ªáu c√¢u h·ªèi load t·ª´ API -->
          </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button id="btnAddSelectedQuestions" class="btn btn-primary">Th√™m c√¢u h·ªèi ƒë√£ ch·ªçn</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">ƒê√≥ng</button>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  let selectedQuestions = [];

  // M·ªü modal ch·ªçn c√¢u h·ªèi
  document.getElementById('btnOpenSelectQuestions').addEventListener('click', () => {
    $('#selectQuestionsModal').modal('show');
  });

  // Load c√¢u h·ªèi t·ª´ API m·ªói l·∫ßn modal hi·ªán l√™n
  $('#selectQuestionsModal').on('show.bs.modal', function () {
    const tbody = document.getElementById('questionsTableBody');
    tbody.innerHTML = '<tr><td colspan="3">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';

    fetch('https://dacn-be-hh2q.onrender.com/v1/api/questions')
      .then(res => res.json())
      .then(data => {
        tbody.innerHTML = '';
        data.forEach(q => {
          if (!q || !q._id) {
            console.warn('C√¢u h·ªèi kh√¥ng h·ª£p l·ªá:', q);
            return;
          }
          const isChecked = selectedQuestions.includes(q._id.toString());

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><input type="checkbox" class="question-checkbox" value="${q._id}" ${isChecked ? 'checked' : ''}></td>
            <td>${q.code || ''}</td>
            <td>${q.content || ''}</td>
          `;
          tbody.appendChild(tr);
        });
      })
      .catch(err => {
        tbody.innerHTML = `<tr><td colspan="3" class="text-danger">L·ªói t·∫£i d·ªØ li·ªáu c√¢u h·ªèi</td></tr>`;
        console.error('L·ªói l·∫•y c√¢u h·ªèi:', err);
      });
  });

  // C·∫≠p nh·∫≠t danh s√°ch khi ch·ªçn c√¢u h·ªèi
  document.getElementById('btnAddSelectedQuestions').addEventListener('click', () => {
    const checkboxes = document.querySelectorAll('.question-checkbox');
    selectedQuestions = Array.from(checkboxes)
      .filter(cb => cb.checked)
      .map(cb => cb.value);

    const listEl = document.getElementById('selectedQuestionsList');
    listEl.innerHTML = '';

    if (selectedQuestions.length === 0) {
      listEl.innerHTML = '<li class="list-group-item text-muted">Ch∆∞a ch·ªçn c√¢u h·ªèi n√†o.</li>';
    } else {
      fetch('http://localhost:8080/v1/api/questions')
        .then(res => res.json())
        .then(data => {
          selectedQuestions.forEach(id => {
            const q = data.find(item => item._id === id);
            if (q) {
              const li = document.createElement('li');
              li.className = 'list-group-item';
              li.textContent = `${q.code || q._id}: ${q.content}`;
              listEl.appendChild(li);
            }
          });
        });
    }

    $('#selectQuestionsModal').modal('hide');
  });

  function loadDanhSachDeThi() {
  const tbody = document.querySelector('table tbody');
  tbody.innerHTML = '<tr><td colspan="14">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';

  fetch('http://localhost:8080/v1/api/exams')
    .then(res => res.json())
    .then(data => {
      tbody.innerHTML = '';
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="14" class="text-muted">Kh√¥ng c√≥ ƒë·ªÅ thi n√†o.</td></tr>';
        return;
      }

      data.forEach((exam, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${exam.title || ''}</td>
          <td>${exam.code || ''}</td>
          <td>${exam.duration || ''}</td>
          <td>${exam.questionType || ''}</td>
          <td>${exam.grade || ''}</td>
          <td>${exam.subject || ''}</td>
          <td>${exam.startTime ? new Date(exam.startTime).toLocaleString() : ''}</td>
          <td>${exam.endTime ? new Date(exam.endTime).toLocaleString() : ''}</td>
          <td>${exam.questionIds?.length || 0}</td>
          <td><a href="#">Xem</a></td>
          <td>${exam.status || ''}</td>
          <td><button class="btn btn-sm btn-warning">S·ª≠a</button></td>
          <td><button class="btn btn-sm btn-danger btn-delete-exam" data-id="${exam._id}">Xo√°</button></td>
        `;
        tbody.appendChild(row);
      });

      // üö® B∆Ø·ªöC 2: G·∫Øn s·ª± ki·ªán click cho t·∫•t c·∫£ n√∫t xo√°
      const deleteButtons = document.querySelectorAll('.btn-delete-exam');
      deleteButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const examId = btn.getAttribute('data-id');
          if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën xo√° ƒë·ªÅ thi n√†y?')) {
            fetch(`http://localhost:8080/v1/api/exams/${examId}`, {
              method: 'DELETE',
            })
              .then(res => {
                if (!res.ok) throw new Error('Xo√° th·∫•t b·∫°i');
                alert('ƒê√£ xo√° ƒë·ªÅ thi th√†nh c√¥ng!');
                loadDanhSachDeThi(); // T·∫£i l·∫°i danh s√°ch sau khi xo√°
              })
              .catch(err => {
                console.error('L·ªói xo√° ƒë·ªÅ thi:', err);
                alert('Kh√¥ng th·ªÉ xo√° ƒë·ªÅ thi.');
              });
          }
        });
      });
    })
    .catch(err => {
      tbody.innerHTML = '<tr><td colspan="14" class="text-danger">L·ªói t·∫£i danh s√°ch ƒë·ªÅ thi.</td></tr>';
      console.error('L·ªói khi l·∫•y danh s√°ch ƒë·ªÅ thi:', err);
    });
  }


  // G·ª≠i form t·∫°o ƒë·ªÅ thi
  document.getElementById('examForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const form = e.target;
    const formData = new FormData(form);

    // L·∫•y th√¥ng tin t·ª´ form
    const examData = {
      title: formData.get('tenDe'),
      code: formData.get('maDe'),
      grade: formData.get('lopHoc'),
      subject: formData.get('monHoc'),
      duration: Number(formData.get('thoiGian')),
      startTime: formData.get('batDau') ? new Date(formData.get('batDau')).toISOString() : null,
      endTime: formData.get('ketThuc') ? new Date(formData.get('ketThuc')).toISOString() : null,
      questionType: formData.get('loaiDe'),
      questionIds: selectedQuestions,
      status: formData.get('trangThai'),
      pdfFileName: formData.get('pdfFile') ? document.getElementById('pdfFile').files[0]?.name || null : null,
    };

    // N·∫øu lo·∫°i ƒë·ªÅ l√† upload PDF, ki·ªÉm tra file
    if (examData.questionType === 'upload_pdf') {
      if (!formData.get('pdfFile') || !document.getElementById('pdfFile').files.length) {
        alert('B·∫°n ph·∫£i ch·ªçn file PDF ƒë·ªÉ t·∫£i l√™n.');
        return;
      }
    }

    // G·ª≠i d·ªØ li·ªáu l√™n backend
    fetch('http://localhost:8080/v1/api/exams', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(examData)
    })
    .then(res => {
      if (res.ok) {
        alert('T·∫°o ƒë·ªÅ thi th√†nh c√¥ng!');
        $('#addExamModal').modal('hide');
        form.reset();
        selectedQuestions = [];
        document.getElementById('selectedQuestionsList').innerHTML = '<li class="list-group-item text-muted">Ch∆∞a ch·ªçn c√¢u h·ªèi n√†o.</li>';
        loadDanhSachDeThi();
      } else {
        return res.json().then(data => {
          alert('L·ªói khi t·∫°o ƒë·ªÅ thi: ' + (data.message || ''));
        });
      }
    })
    .catch(err => {
      alert('L·ªói m·∫°ng khi t·∫°o ƒë·ªÅ thi.');
      console.error(err);
    });
  });

  document.addEventListener('DOMContentLoaded', () => {
    loadDanhSachDeThi();
  });
</script>

</body>
</html>